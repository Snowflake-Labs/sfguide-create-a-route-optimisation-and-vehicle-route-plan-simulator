## Snowflake Notebook Cell Metadata Standards

These standards ensure notebooks are editable and render consistently in Snowflake. Derived from working notebooks in `dataops/event/notebooks/`.

### Cell-level Metadata Fields (observed)
- `name` (string): Stable identifier for cross-references (e.g., used in SQL via `{{ cell_name }}` patterns or narrative links). Keep unique and descriptive.
- `language` (string): One of `sql` or `python` for code cells; omitted for markdown.
- `collapsed` (boolean): Controls whether cell content is initially collapsed in the UI.
- `codeCollapsed` (boolean): For code cells, collapses only the code area while preserving outputs.
- `resultHeight` (number): Preferred render height for results area (markdown cells often include this).
- `id` (UUID): Auto-generated by the editor; keep stable across edits to preserve anchors.

### Adding Cells
- Use the Snowflake UI (preferred) so `id` and metadata are generated correctly.
- Set `metadata.language` to `sql` for SQL cells and `python` for Python cells.
- Assign a unique `metadata.name` using lowercase_with_underscores (e.g., `create_database`, `map_generator`).
- Default visibility:
  - Narrative/section markdown: `collapsed: false`, optional `resultHeight` for long text.
  - Setup SQL (context, env prep): `collapsed: false`, `codeCollapsed: false`.
  - Long or auxiliary SQL/Python: consider `codeCollapsed: true` to reduce clutter.

### Removing Cells
- Remove via Snowflake UI to avoid breaking internal references.
- Before removing, search for downstream references to the cell by `metadata.name` and update or delete them.
- If removing a produced table/view used later, replace with a stub or adjust later cells accordingly.

### Modifying Cells
- Maintain `id` and `name` where possible; if `name` changes, update any textual references and dependent code.
- Keep `language` accurate; do not mix SQL and Python in the same code cell.
- For readability, toggle `collapsed`/`codeCollapsed` instead of deleting context.
- For large outputs, set an appropriate `resultHeight` to avoid overflowing the UI.

### Default View State Conventions
- Headings/markdown introductions: `collapsed: false`, add `resultHeight` (e.g., 88â€“120) if multi-paragraph.
- Parameter/picker cells (e.g., choosing database): show by default; avoid collapse to encourage edits.
- Generated-code execution cells: `codeCollapsed: true` (keep outputs visible, hide code by default).
- Heavy DDL/DML blocks: `codeCollapsed: false` during authoring; may set `true` in final notebooks.

### Notebook-level Metadata
- `metadata.kernelspec`: keep consistent (e.g., `{ name: "streamlit", display_name: "Streamlit Notebook" }`).
- `metadata.lastEditStatus`: system-managed; do not hand-edit.

### Quality Checklist
- [ ] Every code cell has correct `language` and a unique `name`.
- [ ] Section markdown cells have `collapsed: false` and readable `resultHeight` when needed.
- [ ] Long code cells use `codeCollapsed` appropriately (heuristic: >1500 chars of source).
- [ ] No orphan references to removed/renamed cells.
- [ ] IDs preserved across edits; changes done via Snowflake UI where possible.

### Validation Helper
- Run `python3 scripts/validate_notebooks.py` to flag:
  - Long cells missing `codeCollapsed`
  - Tall markdown missing `resultHeight`
  - Missing or duplicate `metadata.name`
  - Invalid `metadata.language` for code cells


